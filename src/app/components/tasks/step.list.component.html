<div class="space-y-3">
    <div class="flex items-center justify-between gap-3 rounded-lg bg-slate-700/50 px-3 py-2">
        <div class="min-w-0">
            <h3 class="truncate text-sm font-semibold text-slate-200 gap-2">
                <mtx-icon [icon]="titleIcon()"></mtx-icon>
                {{ title() }}
            </h3>
            @if (subtitle()) {
            <p class="hidden text-xs text-slate-500 sm:block mt-2">{{ subtitle() }}</p>
            }
        </div>

        <button type="button" class="rounded-full bg-slate-700 px-2 py-0.5 text-slate-200 transition hover:bg-slate-600"
            (click)="toggleCollapse()">
            <mtx-icon [icon]="isCollapsed() ? 'chevron-down text-xs' : 'chevron-up text-xs'"></mtx-icon>
        </button>
    </div>

    @if (!isListCollapsed()) {
    <div class="relative pl-8">
        <div class="absolute bottom-0 left-4 top-0 w-px bg-slate-700/80"></div>

        <div class="space-y-3 steps-drop-list" cdkDropList [cdkDropListData]="steps()"
            (cdkDropListDropped)="dropStep($event)">
            @for (step of steps(); track step.id; let stepIndex = $index) {
            <article class="relative rounded-lg bg-slate-800/50 py-2 pr-3 pl-5 step-card" cdkDrag cdkDragLockAxis="y">
                @if(!step.isExpanded()) {
                <button type="button" class="drag-handle" cdkDragHandle aria-label="Drag step to reorder"
                    title="Drag step to reorder">
                </button>
                }

                <div
                    class="absolute -left-7 top-2 flex h-6 w-6 items-center justify-center rounded-full bg-sky-500 text-xs font-semibold text-slate-950">
                    {{ stepIndex + 1 }}
                </div>

                <div class="flex items-start justify-between gap-3">
                    <button type="button" class="flex min-w-0 flex-1 items-start gap-3 text-left"
                        (click)="toggleStepExpanded(step)">
                        <h3 class="text-sm  text-slate-100">{{ step.title }}</h3>
                    </button>

                    <div class="flex shrink-0 items-center gap-2">
                        <time class="text-xs text-slate-500">{{ step.updatedAt | date:'MMM d, y HH:mm' }}</time>
                        <button type="button" class="rounded-full bg-slate-700 px-2 py-1.5 text-xs text-slate-200"
                            [attr.aria-label]="step.isExpanded() ? 'Collapse step' : 'Expand step'"
                            (click)="toggleStepExpanded(step)">
                            <mtx-icon
                                [icon]="step.isExpanded() ? 'chevron-up text-xs' : 'chevron-down text-xs'"></mtx-icon>
                        </button>
                    </div>
                </div>

                @if (step.isExpanded()) {
                @if (step.isEditing()) {
                <mtx-step-editor [step]="step" (cancel)="onCancelEditStep($event)"
                    (save)="onSaveStep($event)"></mtx-step-editor>
                } @else {
                <mtx-step-card [step]="step" [task]="task()" (onEdit)="editStep($event)"
                    (onDelete)="deleteStep($event)"></mtx-step-card>
                }
                }
            </article>
            }
        </div>
    </div>
    }
</div>