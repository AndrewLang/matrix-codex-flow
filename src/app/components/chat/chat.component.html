<div class="flex h-full overflow-hidden min-h-0 flex-col gap-4 text-slate-200 p-3">
    <div class="relative flex-1 min-h-0">
        <section #transcriptContainer (scroll)="onTranscriptScroll()"
            class="h-full overflow-y-auto rounded-xl pr-2 py-8 backdrop-blur-xl "
            [ngClass]="{ 'bg-slate-900/60 border border-slate-800/80': !hasMessages(), 'bg-slate-900/30': hasMessages() }">
            <div class="space-y-6">
                @if (hasMessages()) {
                @for (message of messages(); track message.id) {
                <article class="flex" [ngClass]="bubbleLayout(message)">
                    <div class="flex flex-col gap-1.5" [ngClass]="bubbleAlign(message)">
                        <div class="w-full rounded-xl py-2 px-3 text-[15px] leading-7" [ngClass]="bubbleColor(message)">
                            <mtx-md-renderer [markdown]="message.content"></mtx-md-renderer>
                        </div>
                        <div class="flex items-center gap-1 px-2">
                            <time class="text-[11px] text-slate-500/90">
                                {{ message.createdAt | formatTimestamp }}
                            </time>
                            <button type="button"
                                class="grid h-6 w-6 place-items-center rounded text-slate-500 transition hover:bg-slate-700/60 hover:text-slate-300"
                                [attr.aria-label]="'Copy message'" (click)="copyMessage(message)">
                                <mtx-icon
                                    [icon]="copiedMessageId() === message.id ? 'check text-xs' : 'copy text-xs'"></mtx-icon>
                            </button>
                        </div>
                    </div>
                </article>
                }} @else {
                <div class="flex flex-col items-center gap-3 text-center">
                    <mtx-icon icon="chat text-4xl text-slate-500"></mtx-icon>
                    <p class="max-w-xs text-sm text-slate-500">No messages yet. </p>
                    <p class="max-w-xs text-sm text-slate-500">Start the conversation by asking a
                        question or giving a command.</p>
                </div>
                }
                @if (isStreaming()) {
                <mtx-loader label="Thinking..."></mtx-loader>
                }
            </div>
        </section>
        @if (showScrollToBottom()) {
        <button type="button"
            class="absolute bottom-4 right-6 grid h-10 w-10 place-items-center rounded-full border-2 border-amber-700 bg-slate-900/95 text-slate-200 shadow shadow-amber-600 transition hover:bg-slate-800"
            aria-label="Scroll to bottom" (click)="scrollToBottomFromButton()">
            <mtx-icon icon="arrow-down"></mtx-icon>
        </button>
        }
    </div>

    <div
        class="flex-none basis-[30%] max-h-[35%] flex flex-col min-h-0 rounded-xl border border-slate-800/80 bg-slate-900/60 p-3 backdrop-blur-xl shadow-xl">

        <div id="threads" class="flex flex-col" [class.flex-1]="showThreads()" [class.min-h-0]="showThreads()">
            @if(hasThreads()) {
            <div class="border-b border-slate-800/80 py-2 mb-2 flex flex-col min-h-0" [class.flex-1]="showThreads()">
                <div id="threads-header" class="flex items-center justify-between" [class.mb-2]="showThreads()">
                    <h3 class="text-xs font-semibold uppercase tracking-wide text-slate-400">Threads history</h3>
                    <button type="button"
                        class="h-6 px-1.5 rounded-full bg-slate-800 text-slate-100 shadow-none transition hover:bg-slate-700"
                        title="Toggle threads history" (click)="toggleThreads()">
                        <mtx-icon [icon]="showThreads() ? 'chevron-up text-sm' : 'chevron-down text-sm'"></mtx-icon>
                    </button>
                </div>

                @if(showThreads()){
                <div id="threads-body" class="flex-1 min-h-0 overflow-y-auto space-y-1.5">
                    @if (threads().length > 0) {
                    @for (thread of threads(); track thread.id) {
                    <button type="button"
                        class="flex items-center justify-between w-full rounded border border-slate-700/70 bg-slate-800/50 px-3 py-2 text-left text-sm text-slate-200 transition hover:bg-slate-700/50"
                        (click)="switchThread(thread)">
                        <div class="truncate text-xs">{{ thread.title || 'Untitled Thread' }}</div>
                        <div class="truncate text-[10px] text-slate-400">{{ thread.createdAt | formatTimestamp }}</div>
                    </button>
                    }
                    } @else {
                    <p class="text-sm text-slate-500">No thread history loaded.</p>
                    }
                </div>
                }
            </div>
            }
        </div>

        @if(!showThreads()){
        <div class="flex flex-1 min-h-0 flex-col gap-2">
            @if(isRunningTask()){
            <mtx-task-runtime></mtx-task-runtime>
            }
            @else {
            <div id="message-input" class="flex-1 overflow-auto min-h-0">
                <mtx-md-editor [value]="composerText()" (valueChange)="composerText.set($event)" background="0f172a99"
                    [enabled]="!isStreaming()" placeholder="Ask VibeFlow" (ctrlEnter)="sendMessage()">
                </mtx-md-editor>
            </div>

            <div id="actions" class="flex items-center justify-between border-t border-slate-800/80 pt-3">
                <div>
                    <mtx-agent-selector [selectedAgent]="selectedAgent()"
                        (selectedAgentChange)="selectedAgent.set($event)">
                    </mtx-agent-selector>
                </div>
                <button type="button"
                    class="h-9 w-9 place-items-center rounded-full bg-slate-800 text-slate-100 shadow-none transition hover:bg-slate-700"
                    aria-label="Send message" (click)="sendMessage()">
                    <mtx-icon icon="send text"></mtx-icon>
                </button>
            </div>
            }
        </div>
        }
    </div>
</div>